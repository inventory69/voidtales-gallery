name: Build Docker images

permissions:
  contents: read
  pull-requests: write

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

jobs:
  build-and-push-dockerfile-image:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      EXT_DL_URL_MARKDOWN: ${{ secrets.EXT_DL_URL_MARKDOWN }}
      EXT_DL_URL_ORIGINAL: ${{ secrets.EXT_DL_URL_ORIGINAL }}
      EXT_DL_URL_MARKDOWN_EXTERNAL: ${{ secrets.EXT_DL_URL_MARKDOWN_EXTERNAL }}
      EXT_DL_URL_ORIGINAL_EXTERNAL: ${{ secrets.EXT_DL_URL_ORIGINAL_EXTERNAL }}

    environment:
      name: production
      url: https://gallery.voidtales.win/

    steps:
      - name: üì• Checkout repo
        uses: actions/checkout@v4
      
      # Install required packages for the cache key generation step
      - name: üì¶ Install dependencies for cache key generation
        run: |
          npm install axios cheerio crypto-js # crypto-js is more reliable as crypto is built-in but can be tricky
        shell: bash

      - name: üîë Generate dynamic cache key from remote files
        id: remote-key-gen
        run: |
          # Use Node.js to fetch the directory listing and create a hash
          node -e "
            const axios = require('axios');
            const cheerio = require('cheerio');
            const crypto = require('crypto');

            async function getFileNames(url, regex) {
              try {
                const res = await axios.get(url, { timeout: 5000 });
                const $ = cheerio.load(res.data);
                const files = [];
                $('a').each((_, el) => {
                  const href = $(el).attr('href');
                  if (href && regex.test(href)) {
                    files.push(href);
                  }
                });
                return files.sort().join('|');
              } catch (error) {
                console.error(\`Error fetching files from ${url}:\`, error.message);
                return '';
              }
            }

            (async () => {
              const mdFiles = await getFileNames(process.env.EXT_DL_URL_MARKDOWN_EXTERNAL, /\.md$/);
              const originalFiles = await getFileNames(process.env.EXT_DL_URL_ORIGINAL_EXTERNAL, /\.(png|jpe?g|webp|bmp)$/i);
              
              const combinedString = mdFiles + '|' + originalFiles;
              const hash = crypto.createHash('sha256').update(combinedString).digest('hex');
              
              console.log(\`Generated cache key: \${hash}\`);
              console.log(\`cache-key=\${hash}\`);
              
              // Set the output for the next steps
              console.log(\`cache-key=\${hash}\`);
              
              // We need to write the output to a file that can be read by a subsequent step
              require('fs').writeFileSync(process.env.GITHUB_OUTPUT, \`cache-key=\${hash}\`);
            })();
          "
        shell: bash
        env:
          EXT_DL_URL_MARKDOWN_EXTERNAL: ${{ secrets.EXT_DL_URL_MARKDOWN_EXTERNAL }}
          EXT_DL_URL_ORIGINAL_EXTERNAL: ${{ secrets.EXT_DL_URL_ORIGINAL_EXTERNAL }}
          
      - name: üóëÔ∏è Remove download markers
        run: |
          rm -f src/content/photos/.downloads_synced
          rm -f public/images/original/.downloads_synced

      # ... (Der Rest des Workflows bleibt unver√§ndert)