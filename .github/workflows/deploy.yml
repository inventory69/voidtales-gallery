name: Build Docker images
# Name of the workflow as it appears in the GitHub Actions UI

on:
  push:
    branches: ["main"]
# The workflow is triggered on every push to the 'main' branch

jobs:
  build-and-push-dockerfile-image:
    # A single job to build and push the Docker image
    runs-on: ubuntu-latest

    # 1. Define an Environment for the job
    environment:
      name: production
      url: https://gallery.voidtales.win/

    steps:
      - name: ðŸ“¥ Checkout repo
        # Action to check out the repository's code
        uses: actions/checkout@v3

      - name: ðŸ”§ Log in to Docker Hub
        # Action to authenticate with Docker Hub using secrets
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }} # Make sure to add the secrets in your repository in -> Settings -> Secrets (Actions) -> New repository secret
          password: ${{ secrets.DOCKERHUB_TOKEN }}    # Make sure to add the secrets in your repository in -> Settings -> Secrets (Actions) -> New repository secret

      - name: ðŸ”¨ Build and push Docker image
        # Action to build the Docker image and push it to the registry
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          # Define the image tag to be pushed, replacing with your own namespace
          tags: |
            inventory69/voidtales-gallery:latest
          platforms: linux/amd64
      
      # Add this step at the end of your existing workflow
      - name: ðŸš€ Trigger Dokploy Deployment
        id: 'laststep'
        # Action to send a POST request to a deployment service
        run: |
            curl -X POST \
            -H "Authorization: Bearer ${{ secrets.DOKPLOY_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{ "image_tag": "inventory69/voidtales-gallery:latest" }' \
            "${{ secrets.API_HOST }}/api/deploy/${{ secrets.DOKPLOY_APP_ID }}"
        env:
            DOKPLOY_API_TOKEN: ${{ secrets.DOKPLOY_API_TOKEN }}
            DOKPLOY_APP_ID: ${{ secrets.DOKPLOY_APP_ID }}