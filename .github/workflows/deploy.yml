name: Build Docker images

permissions:
  contents: read
  pull-requests: write

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

jobs:
  build-and-push-dockerfile-image:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      EXT_DL_URL_MARKDOWN: ${{ secrets.EXT_DL_URL_MARKDOWN }}
      EXT_DL_URL_ORIGINAL: ${{ secrets.EXT_DL_URL_ORIGINAL }}
      EXT_DL_URL_MARKDOWN_EXTERNAL: ${{ secrets.EXT_DL_URL_MARKDOWN_EXTERNAL }}
      EXT_DL_URL_ORIGINAL_EXTERNAL: ${{ secrets.EXT_DL_URL_ORIGINAL_EXTERNAL }}

    environment:
      name: production
      url: https://gallery.voidtales.win/

    steps:
      - name: üì• Checkout repo
        uses: actions/checkout@v4

      # --- Neuer Schritt zum Generieren eines dynamischen Cache-Schl√ºssels ---
      - name: üîë Generate dynamic cache key from remote files
        id: remote-key-gen
        run: |
          # Use Node.js to fetch the directory listing and create a hash
          const axios = require('axios');
          const cheerio = require('cheerio');
          const crypto = require('crypto');

          async function getFileNames(url, regex) {
            try {
              const res = await axios.get(url);
              const $ = cheerio.load(res.data);
              const files = [];
              $('a').each((_, el) => {
                const href = $(el).attr('href');
                if (href && regex.test(href)) {
                  files.push(href);
                }
              });
              return files.sort().join('|');
            } catch (error) {
              console.error(`Error fetching files from ${url}:`, error.message);
              return '';
            }
          }

          (async () => {
            const mdFiles = await getFileNames(process.env.EXT_DL_URL_MARKDOWN_EXTERNAL, /\.md$/);
            const originalFiles = await getFileNames(process.env.EXT_DL_URL_ORIGINAL_EXTERNAL, /\.(png|jpe?g|webp|bmp)$/i);
            
            const combinedString = mdFiles + '|' + originalFiles;
            const hash = crypto.createHash('sha256').update(combinedString).digest('hex');
            
            console.log(`Generated cache key: ${hash}`);
            console.log(`cache-key=${hash}`);
            console.log(`cache-key=${hash}` + " >> $GITHUB_OUTPUT");
          })();
        shell: node
        env:
          EXT_DL_URL_MARKDOWN_EXTERNAL: ${{ secrets.EXT_DL_URL_MARKDOWN_EXTERNAL }}
          EXT_DL_URL_ORIGINAL_EXTERNAL: ${{ secrets.EXT_DL_URL_ORIGINAL_EXTERNAL }}
      
      - name: üóëÔ∏è Remove download markers
        run: |
          rm -f src/content/photos/.downloads_synced
          rm -f public/images/original/.downloads_synced

      # --- Cache-Restore verwendet jetzt den dynamischen Schl√ºssel ---
      - name: üîß Restore downloaded files cache
        id: cache-restore
        uses: actions/cache@v4
        with:
          path: |
            src/content/photos
            public/images/original
          key: ${{ runner.os }}-downloads-${{ steps.remote-key-gen.outputs.cache-key }}
          restore-keys: |
            ${{ runner.os }}-downloads-

      - name: üì¶ Install dependencies
        run: |
          npm install -g pnpm
          pnpm install --frozen-lockfile

      - name: üì• Download files (if not cached)
        env:
          EXT_DL_URL_MARKDOWN: ${{ secrets.EXT_DL_URL_MARKDOWN }}
          EXT_DL_URL_ORIGINAL: ${{ secrets.EXT_DL_URL_ORIGINAL }}
          EXT_DL_URL_MARKDOWN_EXTERNAL: ${{ secrets.EXT_DL_URL_MARKDOWN_EXTERNAL }}
          EXT_DL_URL_ORIGINAL_EXTERNAL: ${{ secrets.EXT_DL_URL_ORIGINAL_EXTERNAL }}
        run: |
          pnpm run copy:md-files
          pnpm run copy:original-images
          
      - name: üóëÔ∏è Remove thumbnail marker
        run: rm -f .thumbs_generated

      - name: üîß Cache thumbnails
        uses: actions/cache@v4
        with:
          path: public/images/thumbs
          key: thumbs-${{ runner.os }}-${{ hashFiles('package.json', 'pnwm-lock.yaml', 'scripts/generate-thumbs.js', 'public/images/original/**') }}
          restore-keys: |
            thumbs-${{ runner.os }}-

      - name: üñºÔ∏è Generate thumbnails (if not cached)
        run: |
          mkdir -p public/images/thumbs
          pnpm run gen:thumbs

      - name: üîß Save thumbnails cache
        uses: actions/cache/save@v4
        with:
          path: public/images/thumbs
          key: thumbs-${{ runner.os }}-${{ hashFiles('package.json', 'pnwm-lock.yaml', 'scripts/generate-thumbs.js', 'public/images/original/**') }}

      - name: üîß Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: üî® Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            inventory69/voidtales-gallery:latest
          platforms: linux/amd64
          build-args: |
            EXT_DL_URL_MARKDOWN=${{ env.EXT_DL_URL_MARKDOWN }}
            EXT_DL_URL_ORIGINAL=${{ env.EXT_DL_URL_ORIGINAL }}
            EXT_DL_URL_MARKDOWN_EXTERNAL=${{ env.EXT_DL_URL_MARKDOWN_EXTERNAL }}
            EXT_DL_URL_ORIGINAL_EXTERNAL=${{ env.EXT_DL_URL_ORIGINAL_EXTERNAL }}

      - name: üöÄ Trigger Dokploy Deployment
        run: |
          curl -X POST \
          -H "Authorization: Bearer ${{ secrets.DOKPLOY_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{ "image_tag": "inventory69/voidtales-gallery:latest" }' \
          "${{ secrets.API_HOST }}/api/deploy/${{ secrets.DOKPLOY_APP_ID }}"
        env:
          DOKPLOY_API_TOKEN: ${{ secrets.DOKPLOY_API_TOKEN }}
          DOKPLOY_APP_ID: ${{ secrets.DOKPLOY_APP_ID }}