name: Build Docker image and Deploy to Dokploy

permissions:
  contents: read
  pull-requests: write

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  build-and-push-dockerfile-image:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # Environment variables for remote file downloads
    env:
      EXT_DL_URL_MARKDOWN: ${{ secrets.EXT_DL_URL_MARKDOWN }}
      EXT_DL_URL_ORIGINAL: ${{ secrets.EXT_DL_URL_ORIGINAL }}
      EXT_DL_URL_MARKDOWN_EXTERNAL: ${{ secrets.EXT_DL_URL_MARKDOWN_EXTERNAL }}
      EXT_DL_URL_ORIGINAL_EXTERNAL: ${{ secrets.EXT_DL_URL_ORIGINAL_EXTERNAL }}

    environment:
      name: production
      url: https://gallery.voidtales.win/

    steps:
      # ğŸ“¥ Checkout repository
      - name: ğŸ“¥ Checkout repo
        uses: actions/checkout@v4

      # ğŸ”§ Restore npm cache for cache key generation
      - name: ğŸ”§ Restore npm cache for cache key generation
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-axios-cheerio-${{ hashFiles('scripts/get-cache-key.cjs') }}
          restore-keys: |
            ${{ runner.os }}-npm-axios-cheerio-

      # ğŸ“¦ Install dependencies for cache key generation
      - name: ğŸ“¦ Install dependencies for cache key generation
        run: npm install axios cheerio
        shell: bash

      # ğŸ”‘ Generate dynamic cache key from remote files
      - name: ğŸ”‘ Generate dynamic cache key from remote files
        id: remote-key-gen
        run: node scripts/get-cache-key.cjs

      # ğŸ—‘ï¸ Remove download markers before restoring cache
      - name: ğŸ—‘ï¸ Remove download markers
        run: |
          rm -f src/content/photos/.downloads_synced
          rm -f public/images/original/.downloads_synced

      - name: ğŸ”§ Get force-cache-update hash
        id: forcecache
        run: echo "hash=$(md5sum .force-cache-update | cut -d' ' -f1)" >> $GITHUB_OUTPUT

      # ğŸ”§ Restore downloaded files cache
      - name: ğŸ”§ Restore downloaded files cache
        id: cache-restore
        uses: actions/cache@v4
        with:
          path: |
            src/content/photos
            public/images/original
          key: ${{ runner.os }}-downloads-${{ steps.remote-key-gen.outputs.cache-key }}-${{ steps.forcecache.outputs.hash }}
          restore-keys: |
            ${{ runner.os }}-downloads-${{ steps.forcecache.outputs.hash }}

      # ğŸ“¦ Install project dependencies
      - name: ğŸ“¦ Install project dependencies
        run: |
          npm install -g pnpm
          pnpm install --frozen-lockfile

      # ğŸ“¥ Download files if not cached
      - name: ğŸ“¥ Download files (if not cached)
        run: |
          pnpm run copy:md-files
          pnpm run copy:original-images

      # ğŸ—‘ï¸ Remove thumbnail marker before generating thumbnails
      - name: ğŸ—‘ï¸ Remove thumbnail marker
        run: rm -f .thumbs_generated

      # ğŸ”§ Restore thumbnail cache
      - name: ğŸ”§ Restore thumbnail cache
        uses: actions/cache@v4
        with:
          path: public/images/thumbs
          key: thumbs-${{ runner.os }}-${{ hashFiles('package.json', 'pnpm-lock.yaml', 'scripts/generate-thumbs.js', 'public/images/original/**') }}
          restore-keys: |
            thumbs-${{ runner.os }}-

      # ğŸ–¼ï¸ Generate thumbnails if not cached
      - name: ğŸ–¼ï¸ Generate thumbnails (if not cached)
        run: |
          mkdir -p public/images/thumbs
          pnpm run gen:thumbs

      # ğŸ’¾ Save thumbnail cache after generation
      - name: ğŸ’¾ Save thumbnails cache
        uses: actions/cache/save@v4
        with:
          path: public/images/thumbs
          key: thumbs-${{ runner.os }}-${{ hashFiles('package.json', 'pnpm-lock.yaml', 'scripts/generate-thumbs.js', 'public/images/original/**') }}

      # ğŸ”§ Log in to Docker Hub
      - name: ğŸ”§ Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ğŸ”¨ Build and push Docker image
      - name: ğŸ”¨ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            inventory69/voidtales-gallery:latest
          platforms: linux/amd64
          build-args: |
            EXT_DL_URL_MARKDOWN=${{ env.EXT_DL_URL_MARKDOWN }}
            EXT_DL_URL_ORIGINAL=${{ env.EXT_DL_URL_ORIGINAL }}
            EXT_DL_URL_MARKDOWN_EXTERNAL=${{ env.EXT_DL_URL_MARKDOWN_EXTERNAL }}
            EXT_DL_URL_ORIGINAL_EXTERNAL=${{ env.EXT_DL_URL_ORIGINAL_EXTERNAL }}

      # ğŸš® Purge images.json from Cloudflare cache
      - name: ğŸš® Purge images.json from Cloudflare cache
        run: |
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"files":["https://gallery.voidtales.win/images.json"]}'

      # ğŸš€ Trigger Dokploy deployment via API
      - name: ğŸš€ Trigger Dokploy Deployment
        run: |
          curl -X POST \
          -H "Authorization: Bearer ${{ secrets.DOKPLOY_API_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{ "image_tag": "inventory69/voidtales-gallery:latest" }' \
          "${{ secrets.API_HOST }}/api/deploy/${{ secrets.DOKPLOY_APP_ID }}"
        env:
          DOKPLOY_API_TOKEN: ${{ secrets.DOKPLOY_API_TOKEN }}
          DOKPLOY_APP_ID: ${{ secrets.DOKPLOY_APP_ID }}