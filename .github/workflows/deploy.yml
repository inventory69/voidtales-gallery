name: Build Docker images
# Name of the workflow as it appears in the GitHub Actions UI
permissions: # Grant minimal permissions required for this workflow:
  contents: read # read is needed to check out the repository code
  pull-requests: write # write is needed if the workflow interacts with pull requests (e.g., status updates)

on:
  push:
    branches: ["main"]
# The workflow is triggered on every push to the 'main' branch

jobs:
  build-and-push-dockerfile-image:
    # A single job to build and push the Docker image
    runs-on: ubuntu-latest
    timeout-minutes: 30 
    env:
      # Environment variable for the external download URL of markdown files
      EXT_DL_URL_MARKDOWN: ${{ secrets.EXT_DL_URL_MARKDOWN }}
      # Environment variable for the external download URL of original files
      EXT_DL_URL_ORIGINAL: ${{ secrets.EXT_DL_URL_ORIGINAL }}
      # Environment variable for the external download URL of markdown files from external sources
      EXT_DL_URL_MARKDOWN_EXTERNAL: ${{ secrets.EXT_DL_URL_MARKDOWN_EXTERNAL }}
      # Environment variable for the external download URL of original files from external sources
      EXT_DL_URL_ORIGINAL_EXTERNAL: ${{ secrets.EXT_DL_URL_ORIGINAL_EXTERNAL }}

    # 1. Define an Environment for the job
    environment:
      name: production
      url: https://gallery.voidtales.win/

    steps:
      - name: ðŸ“¥ Checkout repo
        # Action to check out the repository's code
        uses: actions/checkout@v4  # Updated to v4 for better compatibility

      - name: ðŸ”§ Cache downloaded files
        uses: actions/cache@v4
        with:
          path: |
            ./src/content/photos/
            ./public/images/original/
            ./public/images/thumbs/  # Cache fÃ¼r Thumbnails
          key: downloads-${{ runner.os }}-${{ hashFiles('package.json', 'pnpm-lock.yaml') }}  # Stable Key
          restore-keys: |
            downloads-${{ runner.os }}-

      - name: ðŸ“¦ Install dependencies
        run: |
          echo "Starting pnpm install at $(date)"
          npm install -g pnpm
          pnpm install --frozen-lockfile
          echo "Finished pnpm install at $(date)"

      - name: ðŸ“¥ Download files (if not cached)
        env:
          # Explicitly set the ENV variables for the download step so that the scripts know the URLs
          EXT_DL_URL_MARKDOWN: ${{ secrets.EXT_DL_URL_MARKDOWN }}
          EXT_DL_URL_ORIGINAL: ${{ secrets.EXT_DL_URL_ORIGINAL }}
          EXT_DL_URL_MARKDOWN_EXTERNAL: ${{ secrets.EXT_DL_URL_MARKDOWN_EXTERNAL }}
          EXT_DL_URL_ORIGINAL_EXTERNAL: ${{ secrets.EXT_DL_URL_ORIGINAL_EXTERNAL }}
        run: |
          pnpm run copy:md-files
          pnpm run copy:original-images

      - name: ðŸ–¼ï¸ Generate thumbnails (if not cached)
        run: |
          mkdir -p ./public/images/thumbs  # Ensure the directory exists
          echo "Checking for existing thumbnails..."
          ls -la ./public/images/thumbs/ || echo "No thumbs directory"
          pnpm run gen:thumbs  # Generate thumbnails after download

      - name: ðŸ”§ Log in to Docker Hub
        # Action to authenticate with Docker Hub using secrets
        uses: docker/login-action@v3  # Updated to v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }} # Make sure to add the secrets in your repository in -> Settings -> Secrets (Actions) -> New repository secret
          password: ${{ secrets.DOCKERHUB_TOKEN }}    # Make sure to add the secrets in your repository in -> Settings -> Secrets (Actions) -> New repository secret

      - name: ðŸ”¨ Build and push Docker image
        # Action to build the Docker image and push it to the registry
        uses: docker/build-push-action@v5  # Updated to v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          # Define the image tag to be pushed, replacing with your own namespace
          tags: |
            inventory69/voidtales-gallery:latest
          platforms: linux/amd64
          # Build-Args: Pass the environment variables to the Docker build (if the Dockerfile needs them)
          build-args: |
            EXT_DL_URL_MARKDOWN=${{ env.EXT_DL_URL_MARKDOWN }}
            EXT_DL_URL_ORIGINAL=${{ env.EXT_DL_URL_ORIGINAL }}
            EXT_DL_URL_MARKDOWN_EXTERNAL=${{ env.EXT_DL_URL_MARKDOWN_EXTERNAL }}
            EXT_DL_URL_ORIGINAL_EXTERNAL=${{ env.EXT_DL_URL_ORIGINAL_EXTERNAL }}
      
      # Add this step at the end of your existing workflow
      - name: ðŸš€ Trigger Dokploy Deployment
        id: 'laststep'
        # Action to send a POST request to a deployment service
        run: |
            curl -X POST \
            -H "Authorization: Bearer ${{ secrets.DOKPLOY_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{ "image_tag": "inventory69/voidtales-gallery:latest" }' \
            "${{ secrets.API_HOST }}/api/deploy/${{ secrets.DOKPLOY_APP_ID }}"
        env:
            DOKPLOY_API_TOKEN: ${{ secrets.DOKPLOY_API_TOKEN }}
            DOKPLOY_APP_ID: ${{ secrets.DOKPLOY_APP_ID }}