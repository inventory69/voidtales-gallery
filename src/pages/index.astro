---
import ThemeToggle from '../components/ThemeToggle.jsx';
import SortSelector from '../components/SortSelector';
import { siteConfig } from '../config/site.js';
import { navigationLinks } from '../config/navigation.js';
import { sortPhotos } from '../utils/sortPhotos.js';

import Header from '../components/Header.astro';
import PhotoGrid from '../components/PhotoGrid.astro';
import Footer from '../components/Footer.astro';

// Photo frontmatter type definition
type PhotoFrontmatter = {
  date: string;
  [key: string]: any;
};

// Import all photo markdown files eagerly
const modules = import.meta.glob('../content/photos/*.md', { eager: true });

// Extract frontmatter from each module
const photos = Object.values(modules).map((m) =>
  (m as { frontmatter: PhotoFrontmatter })?.frontmatter ?? m
) as PhotoFrontmatter[];

// Sort photos by date and time (newest first)
const sortedPhotos = sortPhotos(photos, siteConfig.defaultSort);
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="icon" type="image/x-icon" href={siteConfig.favicon} />
    <link rel="manifest" href={siteConfig.manifest} />
    {siteConfig.fonts.map(fontUrl => (
      <link href={fontUrl} rel="stylesheet" />
    ))}
    <title>{siteConfig.name}</title>
    <meta name="description" content={siteConfig.description} />
    <meta name="keywords" content={siteConfig.keywords.join(', ')} />
    <meta name="author" content={siteConfig.author} />
    <meta property="og:title" content={siteConfig.name} />
    <meta property="og:description" content={siteConfig.description} />
    <meta property="og:image" content={siteConfig.ogImage} />
    <meta property="og:url" content={siteConfig.url} />
    <meta name="twitter:card" content="summary_large_image" />
    <!-- Set theme on initial load -->
    <script>
      // Set theme based on localStorage or system preference, default is dark
      (function() {
        try {
          var saved = localStorage.getItem('theme');
          var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          // Dark Mode ist Standard, Systempräferenz wird berücksichtigt
          var isDark = saved === 'dark' || (!saved && prefersDark) || (!saved && !prefersDark);
          document.documentElement.classList.toggle('dark', isDark);
          document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
          document.documentElement.style.visibility = 'visible';
        } catch(e) {
          document.documentElement.style.visibility = 'visible';
        }
      })();
    </script>
    <style>
      html { visibility: hidden; }
    </style>
    <!-- Load CSS directly after theme script -->
    <link rel="stylesheet" href="/src/styles/variables.css" />
    <link rel="stylesheet" href="/src/styles/base.css" />
    <link rel="stylesheet" href="/src/styles/layout.css" />
    <link rel="stylesheet" href="/src/styles/components.css" />
    <link rel="stylesheet" href="/src/styles/hero.css" />
    <link rel="stylesheet" href="/src/styles/responsive.css" />
    <link rel="stylesheet" href="/src/styles/accessibility.css" />
  </head>
  <body style={`--site-font-family: ${siteConfig.fontFamily};`}>
    <div id="background"></div>
    <Header />
    {/* Mobile menu dropdown */}
    <div id="mobile-menu" class="mobile-menu">
      <nav class="mobile-nav" role="navigation" aria-label="Mobile navigation">
        {navigationLinks.map(link => (
          <a href={link.href} class="nav-link">{link.label}</a>
        ))}
      </nav>
      <div class="mobile-actions">
        <SortSelector client:load />
        <ThemeToggle client:load />
      </div>
    </div>
    
    {/* Hero section */}
    <section class="hero">
      <div class="hero-content">
        <h1 class="hero-title" style={`font-family: ${siteConfig.fontFamilyHead};`}>{siteConfig.hero.title}</h1>
        <p class="hero-subtitle" style={`font-family: ${siteConfig.fontFamily};`}>{siteConfig.hero.subtitle}</p>
        <a href="#photos" class="hero-cta" style={`font-family: ${siteConfig.fontFamily};`}>{siteConfig.hero.cta}</a>
      </div>
    </section>
    
    {/* Main photo grid */}
    <div class="page-wrapper">
      <main class="container" role="main" id="photos">
        <PhotoGrid photos={sortedPhotos} />
      </main>
      <Footer />
    </div>

    {/* Mobile menu toggle script */}
    <script>
      // Toggle mobile menu open/close
      const toggle = document.getElementById('mobile-menu-toggle');
      const menu = document.getElementById('mobile-menu');
      if (toggle && menu) {
        toggle.addEventListener('click', () => {
          menu.classList.toggle('open');
        });
      }
    </script>
  </body>
</html>